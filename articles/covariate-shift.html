<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Covariate shift adjustment • densityratio</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Covariate shift adjustment">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">densityratio</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/densityratio.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/covariate-shift.html">Covariate shift adjustment</a></li>
    <li><a class="dropdown-item" href="../articles/high-dim-testing.html">High dimensional two-sample testing</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/thomvolker/densityratio/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Covariate shift adjustment</h1>
                        <h4 data-toc-skip class="author">Carlos Gonzalez
Poses &amp; Thom Benjamin Volker</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thomvolker/densityratio/blob/v0.2.2/vignettes/covariate-shift.Rmd" class="external-link"><code>vignettes/covariate-shift.Rmd</code></a></small>
      <div class="d-none name"><code>covariate-shift.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>densityratio</code> package offers user-friendly and
efficient software for density ratio estimation. The package contains
multiple methods for estimating density ratios, aiming to estimate the
ratio of the probability density functions underlying two groups of
observations. This density ratio is estimated using a one-shot
procedure, without estimating the separate densities. The package
includes different estimation techniques with built-in hyper-parameter
tuning and easy-to-use helper functions to summarize and visualize the
results.</p>
<p>In this <code>getting-started</code> vignette, we guide the user
through the main functionalities of the package. We start by explaining
the concept of density ratio estimation, and the different methods
available in the package. We then show how to estimate density ratios
using the <code>densityratio</code> package for an example case of
distribution shift (i.e., sample selection bias) adaptation.</p>
</div>
<div class="section level2">
<h2 id="density-ratio-estimation">Density ratio estimation<a class="anchor" aria-label="anchor" href="#density-ratio-estimation"></a>
</h2>
<p>The goal of density ratio estimation is to estimate the ratio of two
probability density functions,
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>p</mi><mtext mathvariant="normal">nu</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>p</mi><mtext mathvariant="normal">de</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">
r(x) = \frac{p_\text{nu}(x)}{p_\text{de}(x)},
</annotation></semantics></math> based on samples from the numerator
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mtext mathvariant="normal">nu</mtext></msub><annotation encoding="application/x-tex">p_\text{nu}</annotation></semantics></math>)
and denominator
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mtext mathvariant="normal">de</mtext></msub><annotation encoding="application/x-tex">p_\text{de}</annotation></semantics></math>)
distributions. If the numerator and denominator samples are similar
(i.e., they are samples from a common distribution), the density ratio
will be close to one over the (multivariate) space of the data. If the
numerator and denominator samples are different, the density ratio will
be different from one in those regions where either numerator or
denominator samples are overrepresented. That is, the density ratio will
be large in regions where the numerator samples have high density but
denominator samples have not, and will be small in regions where the
denominator samples have high density but numerator samples have not.
Hence, the estimated density ratio directly shows where and how samples
from two distributions differ.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Throughout the vignette, we illustrate the functionality using the
<code>insurance</code> dataset. The dataset is publicly available on
Kaggle (e.g., <a href="https://www.kaggle.com/datasets/mirichoi0218/insurance" class="external-link">here</a>)
and is included as example data in the <code>densityratio</code>
package. The data contain 1338 observations on the following seven
variables:</p>
<ul>
<li>
<code>age</code>: age of the insured (continuous)</li>
<li>
<code>sex</code>: sex of the insured (old-fashioned binary
variable)</li>
<li>
<code>bmi</code>: body mass index of the insured (continuous)</li>
<li>
<code>children</code>: number of children/dependents covered by the
insurance (integer)</li>
<li>
<code>smoker</code>: whether the insured is a smoker (binary
variable)</li>
<li>
<code>region</code>: the region of the insured (categorical variable
with categories <code>northwest</code>, <code>northeast</code>,
<code>southwest</code> and <code>southeast</code>)</li>
<li>
<code>charges</code>: the medical costs billed by the insurance
(continuous)</li>
</ul>
<p>In this vignette, we first discuss the mechanics of the density ratio
package for distribution comparison, and then show how it can be used in
covariate shift problems. For these examples, we create training and
test data under two settings in which we train a prediction model on the
training data to predict insurance charges in the test data. In the
first setting, the test data is randomly drawn from the insurance data,
and the remaining cases are used for training (this setting is denoted
<code>rs</code> throughout, which is short for random sample). In the
second setting (denoted <code>cs</code> for
<code>covariate shift</code>), we split the data based on the region
variable, such that the training data contains only cases from the
southern regions, while the test data contains cases from the northern
regions. In the second setting, covariate shift may be present, as the
different regions may have different distributions on the covariates
used in the prediction models. Importantly, we assume that the
conditional distribution of the insurance charges given the covariates
is the same in both regions. This assumption may not hold if the regions
also differ on unobserved confounders, but to keep the vignette focused,
we ignore this issue here. We then train a prediction model on the
southern regions and use it to predict insurance charges in the northern
regions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://thomvolker.github.io/densityratio/">densityratio</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">south</span> <span class="op">&lt;-</span> <span class="va">insurance</span><span class="op">$</span><span class="va">region</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"southwest"</span>, <span class="st">"southeast"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">insurance</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">region</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trainidx_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">south</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, subset <span class="op">=</span> <span class="va">trainidx_rs</span><span class="op">)</span></span>
<span><span class="va">test_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, subset <span class="op">=</span> <span class="op">!</span><span class="va">trainidx_rs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, subset <span class="op">=</span> <span class="va">south</span><span class="op">)</span></span>
<span><span class="va">test_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, subset <span class="op">=</span> <span class="op">!</span><span class="va">south</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimating-the-density-ratio">Estimating the density ratio<a class="anchor" aria-label="anchor" href="#estimating-the-density-ratio"></a>
</h2>
<p>The <code>densityratio</code> package includes multiple methods for
estimating the density ratio that each has its own estimation function
(e.g., unconstrained least-squares importance fitting
<code><a href="../reference/ulsif.html">ulsif()</a></code>, Kullback-Leibler importance estimation procedure
<code><a href="../reference/kliep.html">kliep()</a></code>, spectral density ratio estimation
<code><a href="../reference/spectral.html">spectral()</a></code>, and so on). Each method corresponds to a
slightly different model or estimation routine, although all methods use
non-parametric estimation techniques based on Gaussian kernel
transformations of the input data (with bandwidth parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
that is automatically tuned through cross-validation). Moreover, all
functions operate similarly. The user provides two data sets, containing
the numerator and denominator samples, and the function returns a
<code>densityratio</code> object, which can be used and examined. These
<code>densityratio</code> objects can always be further inspected with
corresponding <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
methods.</p>
<p>In what follows, we use unconstrained least-squares importance
fitting (ulsif) to estimate the density ratio, as it is fast and
efficient. We remove the outcome variable <code>charges</code> from the
data before passing it to the <code><a href="../reference/ulsif.html">ulsif()</a></code> function, because we
typically don’t have access to the outcome variable in the testing
setting. Hence, we do not want to reweigh samples based on the outcome
variable.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dr_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ulsif.html">ulsif</a></span><span class="op">(</span><span class="va">test_rs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span>,</span>
<span>               <span class="va">train_rs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dr_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ulsif.html">ulsif</a></span><span class="op">(</span><span class="va">test_cs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span>,</span>
<span>               <span class="va">train_cs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The resulting <code>ulsif</code> objects contain the estimated
density ratio, but also the optimal parameters that can be used to
predict the density ratio for new data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dr_rs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ulsif(df_numerator = subset(test_rs, select = -charges), df_denominator = subset(train_rs,     select = -charges))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Kernel Information:</span></span>
<span><span class="co">#&gt;   Kernel type: Gaussian with L2 norm distances</span></span>
<span><span class="co">#&gt;   Number of kernels: 200</span></span>
<span><span class="co">#&gt;   sigma: num [1:10] 0.813 1.185 1.366 1.528 1.678 ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regularization parameter (lambda): num [1:20] 1000 483.3 233.6 112.9 54.6 ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal sigma (loocv): 2.802938</span></span>
<span><span class="co">#&gt; Optimal lambda (loocv): 2.976351</span></span>
<span><span class="co">#&gt; Optimal kernel weights (loocv): num [1:201] 0.01462 0.01017 0.00757 0.00554 0.00745 ...</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>The output shows the number of inducing points used in the estimation
(number of kernels), and the grid of bandwidth (sigma) and
regularization parameters (lambda) used in the cross-validation.
Moreover, the output shows the optimal bandwidth parameter, the optimal
regularization parameter lambda and the optimal kernel weights, all
optimized through leave-one-out cross-validation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dr_cs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ulsif(df_numerator = subset(test_cs, select = -charges), df_denominator = subset(train_cs,     select = -charges))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Kernel Information:</span></span>
<span><span class="co">#&gt;   Kernel type: Gaussian with L2 norm distances</span></span>
<span><span class="co">#&gt;   Number of kernels: 200</span></span>
<span><span class="co">#&gt;   sigma: num [1:10] 0.856 1.225 1.416 1.59 1.753 ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regularization parameter (lambda): num [1:20] 1000 483.3 233.6 112.9 54.6 ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal sigma (loocv): 1.224742</span></span>
<span><span class="co">#&gt; Optimal lambda (loocv): 0.3359818</span></span>
<span><span class="co">#&gt; Optimal kernel weights (loocv): num [1:201] 0.27465 0.0706 0.03061 -0.00883 0.01246 ...</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>Comparing the two density ratio objects shows that under covariate
shift, the optimal bandwidth parameter and regularization parameter are
somewhat smaller than under random sampling, which implies that the
model is more sensitive to smaller deviations between the two
distributions.</p>
<p>One can obtain additional information on the density ratio object by
calling the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function. This function again shows
the optimal hyper-parameters, and adds information on the divergence
between the two distributions. Note, here, that different estimation
functions typically use different divergence measures. However, for each
estimation function and corresponding divergence measure, one may
formally test whether the two distributions are equal using a
permutation test. This can be done by setting the
<code>test = TRUE</code> argument in the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dr_rs</span>, test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ulsif(df_numerator = subset(test_rs, select = -charges), df_denominator = subset(train_rs,     select = -charges))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Kernel Information:</span></span>
<span><span class="co">#&gt;   Kernel type: Gaussian with L2 norm distances</span></span>
<span><span class="co">#&gt;   Number of kernels: 200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal sigma: 2.802938</span></span>
<span><span class="co">#&gt; Optimal lambda: 2.976351</span></span>
<span><span class="co">#&gt; Optimal kernel weights: num [1:201] 0.01462 0.01017 0.00757 0.00554 0.00745 ...</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Pearson divergence between P(nu) and P(de): 0.02298</span></span>
<span><span class="co">#&gt; Pr(P(nu)=P(de)) =  0.28</span></span>
<span><span class="co">#&gt; Bonferroni-corrected for testing with r(x) = P(nu)/P(de) AND r*(x) = P(de)/P(nu).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dr_cs</span>, test <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; ulsif(df_numerator = subset(test_cs, select = -charges), df_denominator = subset(train_cs,     select = -charges))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Kernel Information:</span></span>
<span><span class="co">#&gt;   Kernel type: Gaussian with L2 norm distances</span></span>
<span><span class="co">#&gt;   Number of kernels: 200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Optimal sigma: 1.224742</span></span>
<span><span class="co">#&gt; Optimal lambda: 0.3359818</span></span>
<span><span class="co">#&gt; Optimal kernel weights: num [1:201] 0.27465 0.0706 0.03061 -0.00883 0.01246 ...</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Pearson divergence between P(nu) and P(de): 0.1221</span></span>
<span><span class="co">#&gt; Pr(P(nu)=P(de)) &lt; .001</span></span>
<span><span class="co">#&gt; Bonferroni-corrected for testing with r(x) = P(nu)/P(de) AND r*(x) = P(de)/P(nu).</span></span></code></pre></div>
<p>These summaries indeed show that the two distributions are not
significantly different under random sampling, but differ significantly
under our covariate shift setting. Performing the permutation test might
take some time, but it can be sped up by parallelizing the computation
(by setting <code>parallel = TRUE</code>).</p>
</div>
<div class="section level2">
<h2 id="visualization-methods">Visualization methods<a class="anchor" aria-label="anchor" href="#visualization-methods"></a>
</h2>
<p>The <code>densityratio</code> package contains several visualization
methods that may aid in interpreting the estimated density ratio. These
plots functions build on the <code>ggplot2</code> library, and return a
customizable <code>ggplot</code> object. The default <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
method produces a histogram of the log density ratio values for both
groups of samples (numerator and denominator). The <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
function takes several arguments that allow to customize the plot, such
as the <code>samples</code> argument, which allows to only plot
numerator or denominator samples, the <code>logscale</code> argument to
indicate whether to plot the log density ratio values, and so on (run
<code><a href="../reference/dr.histogram.html">?plot.ulsif</a></code> for more information). The default
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> summarizes the similarity of the samples through the
density ratio. When the numerator and denominator samples are drawn from
the same distribution, the density ratio should be close to 1 (and close
to 0 on a log-scale). Moreover, the distribution of the density ratio
values should be very similar for both the numerator and denominator
samples.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dr_rs</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value `binwidth`.</span></span></code></pre></div>
<div class="float">
<img src="covariate-shift-plot-dr-rs-1.png" alt="Distribution of density ratio values under random sampling."><div class="figcaption">Distribution of density ratio values under
random sampling.</div>
</div>
<p>In cases where the numerator and denominator samples have different
densities, the density ratio values will be different from 1, and more
importantly, the distributions of density ratio values over the two
groups will overlap to a lesser extent. Hence, numerator samples will
typically have estimated density ratio values larger than 1, while
denominator samples will have density ratio values smaller than 1 (or,
on a logarithmic scale, larger and smaller than zero, respectively).
This is exactly what we see in the figure below: numerator samples
(i.e., the test cases) typically have larger estimated density ratio
values than the denominator (training) samples, although the difference
is not that large here (but note the different scale of the x-axis
compared to the previous plot). ´</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dr_cs</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value `binwidth`.</span></span></code></pre></div>
<div class="float">
<img src="covariate-shift-plot-dr-cs-1.png" alt="Distribution of density ratio values under covariate shift."><div class="figcaption">Distribution of density ratio values under
covariate shift.</div>
</div>
<p>The package comes with two additional plotting functions:
<code><a href="../reference/plot_univariate.html">plot_univariate()</a></code> and <code><a href="../reference/plot_bivariate.html">plot_bivariate()</a></code>. The
<code><a href="../reference/plot_univariate.html">plot_univariate()</a></code> plots the density ratio values against
each variable separately, which can help to identify those variables
that are most informative for the density ratio. Below, we plot the
density ratio values against the variables <code>age</code> and
<code>bmi</code> (and set <code>grid = TRUE</code> to add the two
figures in a grid). For age there seems no trend: the density ratio
values are quite randomly distributed over the age range. For
<code>bmi</code>, the pattern is different. People in the numerator
sample (i.e., the test cases), seem to have lower <code>bmi</code>
values in general, whereas the higher <code>bmi</code> values occur more
often for the denominator (training) samples. This results in a higher
density ratio for lower <code>bmi</code> values, and a lower density
ratio for higher <code>bmi</code> values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_univariate.html">plot_univariate</a></span><span class="op">(</span><span class="va">dr_cs</span>, vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"bmi"</span><span class="op">)</span>, grid <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="covariate-shift-plot-dr-univariate-1.png" alt="Univariate plots of age and bmi against the estimated density ratio values for the two groups of samples under covariate shift."><div class="figcaption">Univariate plots of <code>age</code> and
<code>bmi</code> against the estimated density ratio values for the two
groups of samples under covariate shift.</div>
</div>
<p>The <code><a href="../reference/plot_bivariate.html">plot_bivariate()</a></code> function is available to plot the
density ratio values for pairs of variables (with the density ratio
value mapped to the color scale). We can again select the variables for
which we want to create the scatterplots using <code>vars</code>, and
the function will create a scatterplot for each pair of variables.
Again, we solely observe a pattern for <code>bmi</code>, with higher
values corresponding to lower density ratio values.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_bivariate.html">plot_bivariate</a></span><span class="op">(</span><span class="va">dr_cs</span>, vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"bmi"</span>, <span class="st">"children"</span><span class="op">)</span>, grid <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="covariate-shift-plot-dr-bivariate-1.png" alt="Bivariate scatter plots for age, bmi and children for two groups of samples under covariate shift, with density ratio values mapped to the color scale."><div class="figcaption">Bivariate scatter plots for <code>age</code>,
<code>bmi</code> and <code>children</code> for two groups of samples
under covariate shift, with density ratio values mapped to the color
scale.</div>
</div>
</div>
<div class="section level2">
<h2 id="covariate-shift">Covariate shift<a class="anchor" aria-label="anchor" href="#covariate-shift"></a>
</h2>
<p>We now show how the <code>densityratio</code> package can be used to
deal with covariate shift. Throughout, we attempt to predict the outcome
variable <code>charges</code> using the predictor variables
<code>age</code>, <code>sex</code>, <code>bmi</code>,
<code>children</code>, and <code>smoker</code>. A common assumption of
many statistical analyses is that training and test samples are drawn
from the same distribution. If this assumption is met, least-squares
regression (and many other statistical learning techniques, such as
random forests and support vector regression) yield consistent estimates
of the model parameters, in the sense that the estimates converge to the
<em>optimal</em> model parameters as the sample size increases. We can
obtain estimates of the model parameters by solving the least-squares
problem
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>β</mi><mo accent="true">̂</mo></mover><mo>=</mo><mo>arg</mo><munder><mo>min</mo><mi>β</mi></munder><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow></msub><mo>−</mo><msubsup><mi>x</mi><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow><mi>T</mi></msubsup><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mtext mathvariant="normal">tr</mtext><mi>T</mi></msubsup><msub><mi>X</mi><mtext mathvariant="normal">tr</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mtext mathvariant="normal">tr</mtext><mi>T</mi></msubsup><msub><mi>y</mi><mtext mathvariant="normal">tr</mtext></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">
\hat{\beta} = \arg\min_{\beta} \sum_{i=1}^{n} (y_{\text{tr}, i} - x_{\text{tr}, i}^T \beta)^2 = (X_\text{tr}^TX_\text{tr})^{-1}X_\text{tr}^Ty_\text{tr},
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mtext mathvariant="normal">tr</mtext></msub><annotation encoding="application/x-tex">X_\text{tr}</annotation></semantics></math>
is the design matrix of the training data,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mtext mathvariant="normal">tr</mtext></msub><annotation encoding="application/x-tex">y_\text{tr}</annotation></semantics></math>
is the vector of training outcomes, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
is the vector of model parameters.</p>
<p>Under covariate shift, this estimator must no longer be consistent.
In fact, it only is consistent if the analysis model is correctly
specified. This problem can be compensated by reweighing the training
samples using the estimated density ratio, which yields a consistent
estimator under the true density ratio model
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>p</mi><mtext mathvariant="normal">test</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><msub><mi>p</mi><mtext mathvariant="normal">train</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">
r(x) = \frac{p_\text{test}(x)}{p_\text{train}(x)}.
</annotation></semantics></math> Since the true density ratio model is
not known, all we can do is to estimate it from the training and test
data. Consequently, we have
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mtext mathvariant="normal">R</mtext></msub><mo>=</mo><mo>arg</mo><munder><mo>min</mo><mi>β</mi></munder><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mover><mi>r</mi><mo accent="true">̂</mo></mover><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow></msub><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow></msub><mo>−</mo><msubsup><mi>x</mi><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow><mi>T</mi></msubsup><mi>β</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mtext mathvariant="normal">tr</mtext><mi>T</mi></msubsup><mover><mi>R</mi><mo accent="true">̂</mo></mover><msub><mi>X</mi><mtext mathvariant="normal">tr</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mtext mathvariant="normal">tr</mtext><mi>T</mi></msubsup><mover><mi>R</mi><mo accent="true">̂</mo></mover><msub><mi>y</mi><mtext mathvariant="normal">tr</mtext></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">
\hat\beta_\text{R} = \arg\min_{\beta} \sum_{i=1}^{n} \hat{r}_{\text{tr},i} (y_{\text{tr}, i} - x_{\text{tr}, i}^T \beta)^2 = (X_\text{tr}^T \hat{R} X_\text{tr})^{-1}X_\text{tr}^T \hat{R} y_\text{tr},
</annotation></semantics></math> where the density ratio weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>r</mi><mo accent="true">̂</mo></mover><mrow><mtext mathvariant="normal">tr</mtext><mo>,</mo><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\hat{r}_{\text{tr},i}</annotation></semantics></math>
(collected in the diagonal matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat R</annotation></semantics></math>)
are obtained from the estimated density ratio model.</p>
<p>Below, we compare the performance of least squares regression with
and without reweighing on the training and test data. For the sake of
illustration, we do this for data under random sampling, and for our
covariate shift setting. We first fit a least squares regression model
to the training data, and then predict the outcome variable for the test
data, and evaluate the root mean squared error (RMSE) and
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>).</p>
<div class="section level3">
<h3 id="performance-under-random-sampling">Performance under random sampling<a class="anchor" aria-label="anchor" href="#performance-under-random-sampling"></a>
</h3>
<p>Without weighting, we simply fit the regression model as follows.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">charges</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">bmi</span> <span class="op">+</span> <span class="va">children</span> <span class="op">+</span> <span class="va">smoker</span></span>
<span><span class="va">fit_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_rs</span><span class="op">)</span></span></code></pre></div>
<p>We can then predict the outcome variable for the training and test
data, and evaluate the RMSE and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_train_rs</span> <span class="op">&lt;-</span> <span class="va">train_rs</span><span class="op">$</span><span class="va">charges</span></span>
<span><span class="va">y_test_rs</span>  <span class="op">&lt;-</span> <span class="va">test_rs</span><span class="op">$</span><span class="va">charges</span></span>
<span><span class="va">pred_train_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_rs</span>, newdata <span class="op">=</span> <span class="va">train_rs</span><span class="op">)</span></span>
<span><span class="va">pred_test_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_rs</span>, newdata <span class="op">=</span> <span class="va">test_rs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  RMSE_train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_train_rs</span> <span class="op">-</span> <span class="va">pred_train_rs</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  RMSE_test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_test_rs</span> <span class="op">-</span> <span class="va">pred_test_rs</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R2_tr <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_rs</span> <span class="op">-</span> <span class="va">pred_train_rs</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_rs</span><span class="op">)</span>,</span>
<span>  R2_te <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_rs</span> <span class="op">-</span> <span class="va">pred_test_rs</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_rs</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   RMSE_train    RMSE_test        R2_tr        R2_te </span></span>
<span><span class="co">#&gt; 6142.8279347 5990.7051274    0.7503945    0.7455363</span></span></code></pre></div>
<p>These calculations show that the RMSE and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>
values are quite similar for the training and test data, which is
expected under random sampling.</p>
<p>Subsequently, we fit the regression model with reweighing. We can
calculate the weights for the training data using the
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function in the <code>densityratio</code>
package, and then use these weights in the <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">dr_rs</span>, newdata <span class="op">=</span> <span class="va">train_rs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_rs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_rs</span>, weights <span class="op">=</span> <span class="va">weights_rs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_train_rs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_rs_w</span>, newdata <span class="op">=</span> <span class="va">train_rs</span><span class="op">)</span></span>
<span><span class="va">pred_test_rs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_rs_w</span>, newdata <span class="op">=</span> <span class="va">test_rs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  RMSE_train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_train_rs</span> <span class="op">-</span> <span class="va">pred_train_rs_w</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  RMSE_test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_test_rs</span> <span class="op">-</span> <span class="va">pred_test_rs_w</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R2_tr <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_rs</span> <span class="op">-</span> <span class="va">pred_train_rs_w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_rs</span><span class="op">)</span>,</span>
<span>  R2_te <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_rs</span> <span class="op">-</span> <span class="va">pred_test_rs_w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_rs</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   RMSE_train    RMSE_test        R2_tr        R2_te </span></span>
<span><span class="co">#&gt; 6143.7668763 5995.5513712    0.7503211    0.7451020</span></span></code></pre></div>
<p>We see that training and test performance is almost identical to the
unweighted solution, which makes sense as the weights are generally very
close to 1.</p>
</div>
<div class="section level3">
<h3 id="performance-under-covariate-shift">Performance under covariate shift<a class="anchor" aria-label="anchor" href="#performance-under-covariate-shift"></a>
</h3>
<p>We repeat exactly the same procedure as in the previous section, but
now for the setting with covariate shift between training and test
data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_cs</span><span class="op">)</span></span></code></pre></div>
<p>We again predict the outcome variable for the training and test data,
and evaluate the RMSE and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_train_cs</span> <span class="op">&lt;-</span> <span class="va">train_cs</span><span class="op">$</span><span class="va">charges</span></span>
<span><span class="va">y_test_cs</span>  <span class="op">&lt;-</span> <span class="va">test_cs</span><span class="op">$</span><span class="va">charges</span></span>
<span><span class="va">pred_train_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_cs</span>, newdata <span class="op">=</span> <span class="va">train_cs</span><span class="op">)</span></span>
<span><span class="va">pred_test_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_cs</span>, newdata <span class="op">=</span> <span class="va">test_cs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  RMSE_train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_train_cs</span> <span class="op">-</span> <span class="va">pred_train_cs</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  RMSE_test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_test_cs</span> <span class="op">-</span> <span class="va">pred_test_cs</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R2_tr <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_cs</span> <span class="op">-</span> <span class="va">pred_train_cs</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_cs</span><span class="op">)</span>,</span>
<span>  R2_te <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_cs</span> <span class="op">-</span> <span class="va">pred_test_cs</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_cs</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   RMSE_train    RMSE_test        R2_tr        R2_te </span></span>
<span><span class="co">#&gt; 5860.0592523 6434.1388040    0.7944538    0.6722150</span></span></code></pre></div>
<p>Now, the performance of the prediction model decreases substantially
on the test data, as is expected under covariate shift. Hopefully, we
can account for this by reweighing the training data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weights_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">dr_cs</span>, newdata <span class="op">=</span> <span class="va">train_cs</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span>select <span class="op">=</span> <span class="op">-</span><span class="va">charges</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit_cs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_cs</span>, weights <span class="op">=</span> <span class="va">weights_cs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_train_cs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_cs_w</span>, newdata <span class="op">=</span> <span class="va">train_cs</span><span class="op">)</span></span>
<span><span class="va">pred_test_cs_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit_cs_w</span>, newdata <span class="op">=</span> <span class="va">test_cs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  RMSE_train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_train_cs</span> <span class="op">-</span> <span class="va">pred_train_cs_w</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  RMSE_test <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">y_test_cs</span> <span class="op">-</span> <span class="va">pred_test_cs_w</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  R2_tr <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_cs</span> <span class="op">-</span> <span class="va">pred_train_cs_w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_train_cs</span><span class="op">)</span>,</span>
<span>  R2_te <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_cs</span> <span class="op">-</span> <span class="va">pred_test_cs_w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y_test_cs</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   RMSE_train    RMSE_test        R2_tr        R2_te </span></span>
<span><span class="co">#&gt; 6005.6703347 6191.6472513    0.7841192    0.6971867</span></span></code></pre></div>
<p>We see that we get a modest improvement in the RMSE and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>R</mi><mn>2</mn></msup><annotation encoding="application/x-tex">R^2</annotation></semantics></math>
values for the test data, compared to the unweighted solution. The fact
that the improvement is not larger can have multiple reasons. First, of
course, the estimated density ratio model is not perfect, which may
lower the performance of the reweighted regression model. Second, we
have no way of knowing whether our important assumption, namely that
only the covariate distribution of train and test set changed, is
actually met. There could very well be unobserved processes that affect
the selection mechanism and the outcome. Finally, it could very well be
that the performance under random sampling is not even attainable,
because, for example, the distribution of the outcome is different in
the two settings.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">test_cs</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = formula, data = test_cs)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt;  -8867  -3221  -1166   1187  27132 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept) -12619.838   1419.984  -8.887  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; age            242.068     17.155  14.111  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; sexmale          8.815    477.858   0.018 0.985287    </span></span>
<span><span class="co">#&gt; bmi            379.957     43.460   8.743  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; children       759.908    201.638   3.769 0.000179 ***</span></span>
<span><span class="co">#&gt; smokeryes    21320.176    605.795  35.194  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 6077 on 643 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.7061, Adjusted R-squared:  0.7038 </span></span>
<span><span class="co">#&gt; F-statistic:   309 on 5 and 643 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<p>Fitting the same model on the <strong><em>test</em></strong> data
shows that, given our model specification, an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mn>2</mn></msup><mo>=</mo><mn>0.71</mn></mrow><annotation encoding="application/x-tex">R^2 = 0.71</annotation></semantics></math>
is the best we can do, which suggests that our reweighted model is
already quite close to the best possible performance.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this vignette, we showed how the <code>densityratio</code> package
can be used to estimate the density ratio between two data sets, and how
the density ratio can be used to reweigh the training data in a
regression model under covariate shift.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thom Volker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
